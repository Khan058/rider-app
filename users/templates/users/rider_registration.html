{% extends 'administration/base.html' %}

{% block title %}Register New Rider - Rider Admin{% endblock %}

{% block extra_css %}
<!-- Tempus Dominus Styles -->
<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/css/tempus-dominus.min.css"
    crossorigin="anonymous">
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Progress Steps -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <div class="position-relative m-4">
                        <div class="progress" style="height: 2px;">
                            <div class="progress-bar" role="progressbar" style="width: 0%;" id="progressBar"></div>
                        </div>
                        <div class="position-absolute top-0 start-0 translate-middle btn btn-sm btn-primary rounded-pill"
                            style="width: 2rem; height:2rem;">1</div>
                        <div class="position-absolute top-0 start-33 translate-middle btn btn-sm btn-secondary rounded-pill step-indicator"
                            style="width: 2rem; height:2rem; left: 33%;">2</div>
                        <div class="position-absolute top-0 start-66 translate-middle btn btn-sm btn-secondary rounded-pill step-indicator"
                            style="width: 2rem; height:2rem; left: 66%;">3</div>
                        <div class="position-absolute top-0 start-100 translate-middle btn btn-sm btn-secondary rounded-pill step-indicator"
                            style="width: 2rem; height:2rem;">4</div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span class="text-primary fw-bold small">Personal Info</span>
                        <span class="text-muted fw-bold small step-label" style="margin-left: -5%;">License
                            Details</span>
                        <span class="text-muted fw-bold small step-label" style="margin-left: 5%;">Ejari Details</span>
                        <span class="text-muted fw-bold small step-label">Confirmation</span>
                    </div>
                </div>
            </div>

            <!-- Registration Form -->
            <div class="card shadow-sm border-0">
                <div class="card-body p-5">
                    <h2 class="fw-bold mb-4" id="stepTitle">Rider Details</h2>
                    <p class="text-muted mb-4" id="stepDescription">Please provide your personal information to get
                        started.</p>

                    {% if messages %}
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        <i
                            class="bi {% if message.tags == 'success' %}bi-check-circle{% elif message.tags == 'danger' %}bi-exclamation-triangle{% else %}bi-info-circle{% endif %} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                    {% endif %}

                    <form id="registrationForm" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- Step 1: Personal Information -->
                        <div class="step-content" id="step1">
                            <h5 class="text-primary mb-3"><i class="bi bi-person-fill me-2"></i>Personal Information
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-control" name="first_name" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-control" name="last_name" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                                <div class="col-12">
                                    <input type="text" class="form-control" name="address" placeholder="Street Address"
                                        required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Profile Picture</label>
                                    <div class="upload-area border border-2 border-dashed rounded-3 p-4 text-center bg-light position-relative"
                                        id="pictureDropZone">
                                        <input type="file"
                                            class="position-absolute top-0 start-0 w-100 h-100 opacity-0 cursor-pointer"
                                            name="picture" id="pictureInput" accept="image/*">
                                        <div class="mb-3">
                                            <i class="bi bi-person-bounding-box fs-1 text-primary"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">Click to upload or drag and drop</h6>
                                        <p class="text-muted small mb-0">SVG, PNG, JPG</p>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Step 2: License Details -->
                        <div class="step-content d-none" id="step2">
                            <h5 class="text-primary mb-3"><i class="bi bi-card-heading me-2"></i>License Information
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label text-muted small">License Number</label>
                                    <input type="text" class="form-control" name="license_number"
                                        placeholder="Enter license number">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted small">License Expiry</label>
                                    <div class="input-group" id="licenseExpiryPicker" data-td-target-input="nearest"
                                        data-td-target-toggle="nearest">
                                        <input type="text" class="form-control" name="license_expiry_date"
                                            placeholder="mm/dd/yyyy" data-td-target="#licenseExpiryPicker"
                                            data-td-toggle="datetimepicker">
                                        <span class="input-group-text" data-td-target="#licenseExpiryPicker"
                                            data-td-toggle="datetimepicker">
                                            <i class="bi bi-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-12 mt-4">
                                    <label class="form-label text-muted small">Upload License Image</label>
                                    <div class="upload-area p-5 text-center border border-2 border-primary border-opacity-25 rounded-3 bg-light"
                                        style="border-style: dashed !important; position: relative;">
                                        <input type="file"
                                            class="form-control position-absolute top-0 start-0 w-100 h-100 opacity-0"
                                            name="license_image" accept="image/jpeg,image/png,application/pdf"
                                            style="cursor: pointer;">
                                        <div class="mb-3">
                                            <div
                                                class="bg-primary bg-opacity-10 d-inline-flex rounded-circle p-3 text-primary">
                                                <i class="bi bi-cloud-arrow-up-fill fs-3"></i>
                                            </div>
                                        </div>
                                        <h6 class="fw-bold mb-1">Drag & Drop your license here</h6>
                                        <p class="text-muted small mb-2">or <span
                                                class="text-primary text-decoration-underline">browse files</span> from
                                            your computer</p>
                                        <p class="text-muted small" style="font-size: 0.75rem;">Supports: JPG, PNG, PDF
                                            (Max 5MB)</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Ejari Details -->
                        <div class="step-content d-none" id="step3">
                            <h5 class="text-primary mb-3"><i class="bi bi-file-earmark-text me-2"></i>Ejari / Contract
                                Details</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label text-muted small">Ejari Number</label>
                                    <input type="text" class="form-control" name="ejari_number"
                                        placeholder="Enter Ejari number">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted small">Expiry Date</label>
                                    <div class="input-group" id="ejariExpiryPicker" data-td-target-input="nearest"
                                        data-td-target-toggle="nearest">
                                        <input type="text" class="form-control" name="ejari_expiry_date"
                                            placeholder="mm/dd/yyyy" data-td-target="#ejariExpiryPicker"
                                            data-td-toggle="datetimepicker">
                                        <span class="input-group-text" data-td-target="#ejariExpiryPicker"
                                            data-td-toggle="datetimepicker">
                                            <i class="bi bi-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-12 mt-4">
                                    <label class="form-label text-muted small">Upload Ejari Document</label>
                                    <div class="upload-area p-5 text-center border border-2 border-primary border-opacity-25 rounded-3 bg-light"
                                        style="border-style: dashed !important; position: relative;">
                                        <input type="file"
                                            class="form-control position-absolute top-0 start-0 w-100 h-100 opacity-0"
                                            name="ejari_image" accept="image/jpeg,image/png,application/pdf"
                                            style="cursor: pointer;">
                                        <div class="mb-3">
                                            <div
                                                class="bg-primary bg-opacity-10 d-inline-flex rounded-circle p-3 text-primary">
                                                <i class="bi bi-cloud-arrow-up-fill fs-3"></i>
                                            </div>
                                        </div>
                                        <h6 class="fw-bold mb-1">Drag & Drop your Ejari/Contract here</h6>
                                        <p class="text-muted small mb-2">or <span
                                                class="text-primary text-decoration-underline">browse files</span> from
                                            your computer</p>
                                        <p class="text-muted small" style="font-size: 0.75rem;">Supports: JPG, PNG, PDF
                                            (Max 5MB)</p>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Step 4: Confirmation -->
                        <div class="step-content d-none" id="step4">
                            <h2 class="fw-bold mb-2">Review & Confirm</h2>
                            <p class="text-muted mb-4">Please review your information below before submitting your
                                registration.</p>

                            <!-- Personal Details Card -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <h5 class="card-title fw-bold mb-0 text-primary">
                                            <i class="bi bi-person-circle me-2"></i>Personal Details
                                        </h5>
                                        <button type="button" class="btn btn-link text-decoration-none small fw-bold"
                                            onclick="goToStep(1)">EDIT</button>
                                    </div>
                                    <div class="row g-4">
                                        <div class="col-md-6">
                                            <small class="text-muted d-block mb-1">Full Name</small>
                                            <p class="fw-bold mb-0" id="reviewName">-</p>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block mb-1">Email Address</small>
                                            <p class="fw-bold mb-0" id="reviewEmail">-</p>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block mb-1">Phone Number</small>
                                            <p class="fw-bold mb-0" id="reviewPhone">-</p>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block mb-1">Address</small>
                                            <p class="fw-bold mb-0" id="reviewAddress">-</p>
                                        </div>
                                        <div class="col-12">
                                            <div class="p-3 border rounded bg-light d-flex align-items-center mt-3">
                                                <div class="bg-primary bg-opacity-10 text-primary rounded p-2 me-3">
                                                    <i class="bi bi-person-circle fs-4"></i>
                                                </div>
                                                <div class="overflow-hidden">
                                                    <small class="d-block fw-bold text-truncate"
                                                        id="reviewPictureFile">No file uploaded</small>
                                                    <small class="text-muted" style="font-size: 0.7rem;">Profile
                                                        Picture</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-4 mb-4">
                                <!-- License Card -->
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-body p-4">
                                            <div class="d-flex justify-content-between align-items-center mb-4">
                                                <h5 class="card-title fw-bold mb-0 text-primary">
                                                    <i class="bi bi-card-heading me-2"></i>License
                                                </h5>
                                                <button type="button"
                                                    class="btn btn-link text-decoration-none small fw-bold"
                                                    onclick="goToStep(2)">EDIT</button>
                                            </div>
                                            <div class="mb-3">
                                                <small class="text-muted d-block mb-1">License Number</small>
                                                <p class="fw-bold mb-0" id="reviewLicense">-</p>
                                            </div>
                                            <div class="mb-4">
                                                <small class="text-muted d-block mb-1">Expiry Date</small>
                                                <p class="fw-bold mb-0" id="reviewLicenseExp">-</p>
                                            </div>
                                            <div class="p-3 border rounded bg-light d-flex align-items-center">
                                                <div class="bg-danger bg-opacity-10 text-danger rounded p-2 me-3">
                                                    <i class="bi bi-file-earmark-pdf fs-4"></i>
                                                </div>
                                                <div class="overflow-hidden">
                                                    <small class="d-block fw-bold text-truncate"
                                                        id="reviewLicenseFile">No file uploaded</small>
                                                    <small class="text-muted" style="font-size: 0.7rem;">Document
                                                        Preview</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Ejari Card -->
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-body p-4">
                                            <div class="d-flex justify-content-between align-items-center mb-4">
                                                <h5 class="card-title fw-bold mb-0 text-primary">
                                                    <i class="bi bi-house-door me-2"></i>Ejari
                                                </h5>
                                                <button type="button"
                                                    class="btn btn-link text-decoration-none small fw-bold"
                                                    onclick="goToStep(3)">EDIT</button>
                                            </div>
                                            <div class="mb-3">
                                                <small class="text-muted d-block mb-1">Ejari Number</small>
                                                <p class="fw-bold mb-0" id="reviewEjari">-</p>
                                            </div>
                                            <div class="mb-4">
                                                <small class="text-muted d-block mb-1">Expiry Date</small>
                                                <p class="fw-bold mb-0" id="reviewEjariExp">-</p>
                                            </div>
                                            <div class="p-3 border rounded bg-light d-flex align-items-center">
                                                <div class="bg-primary bg-opacity-10 text-primary rounded p-2 me-3">
                                                    <i class="bi bi-file-earmark-image fs-4"></i>
                                                </div>
                                                <div class="overflow-hidden">
                                                    <small class="d-block fw-bold text-truncate" id="reviewEjariFile">No
                                                        file uploaded</small>
                                                    <small class="text-muted" style="font-size: 0.7rem;">Document
                                                        Preview</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Confirmation Checkbox -->
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" value="" id="confirmCheck" required>
                                <label class="form-check-label text-muted small" for="confirmCheck">
                                    I confirm that all information provided is accurate. <br>
                                    By clicking "Complete Registration", you agree to our <a href="#"
                                        class="text-primary text-decoration-none">Terms of Service</a> and <a href="#"
                                        class="text-primary text-decoration-none">Privacy Policy</a>.
                                </label>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-5">
                            <button type="button" class="btn btn-link text-decoration-none text-muted px-0"
                                id="prevBtn"><i class="bi bi-arrow-left me-2"></i>Back</button>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-dark text-white bg-opacity-10 text-reset border-0"
                                    id="saveDraftBtn">Save Draft</button>
                                <button type="button" class="btn btn-primary px-4" id="nextBtn">Next <i
                                        class="bi bi-arrow-right ms-2"></i></button>
                                <button type="submit" class="btn btn-primary px-4 d-none" id="submitBtn">Complete
                                    Registration <i class="bi bi-check-circle-fill ms-2"></i></button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Popperjs -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
    crossorigin="anonymous"></script>
<!-- Tempus Dominus JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/js/tempus-dominus.min.js"
    crossorigin="anonymous"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Tempus Dominus Datepickers
        const licensePickerEl = document.getElementById('licenseExpiryPicker');
        const ejariPickerEl = document.getElementById('ejariExpiryPicker');

        if (licensePickerEl) {
            new tempusDominus.TempusDominus(licensePickerEl, {
                localization: {
                    format: 'L' // Date only format
                },
                display: {
                    components: {
                        clock: false,
                        hours: false,
                        minutes: false,
                        seconds: false
                    },
                    icons: {
                        type: 'icons',
                        time: 'bi bi-clock',
                        date: 'bi bi-calendar',
                        up: 'bi bi-arrow-up',
                        down: 'bi bi-arrow-down',
                        previous: 'bi bi-chevron-left',
                        next: 'bi bi-chevron-right',
                        today: 'bi bi-calendar-check',
                        clear: 'bi bi-trash',
                        close: 'bi bi-x'
                    }
                }
            });
        }

        if (ejariPickerEl) {
            new tempusDominus.TempusDominus(ejariPickerEl, {
                localization: {
                    format: 'L' // Date only format
                },
                display: {
                    components: {
                        clock: false,
                        hours: false,
                        minutes: false,
                        seconds: false
                    },
                    icons: {
                        type: 'icons',
                        time: 'bi bi-clock',
                        date: 'bi bi-calendar',
                        up: 'bi bi-arrow-up',
                        down: 'bi bi-arrow-down',
                        previous: 'bi bi-chevron-left',
                        next: 'bi bi-chevron-right',
                        today: 'bi bi-calendar-check',
                        clear: 'bi bi-trash',
                        close: 'bi bi-x'
                    }
                }
            });
        }

        const steps = 4;
        let currentStep = 1;

        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const submitBtn = document.getElementById('submitBtn');
        const saveDraftBtn = document.getElementById('saveDraftBtn');
        const progressBar = document.getElementById('progressBar');
        const form = document.getElementById('registrationForm');

        // Expose goToStep globally for Edit buttons
        window.goToStep = function (step) {
            currentStep = step;
            updateUI();
        }

        function updateUI() {
            // Update Progress Bar
            const progress = ((currentStep - 1) / (steps - 1)) * 100;
            progressBar.style.width = `${progress}%`;

            // Update Step Indicators
            document.querySelectorAll('.step-indicator').forEach((el, index) => {
                const stepNum = index + 2; // indicators start from 2
                if (stepNum <= currentStep) {
                    el.classList.remove('btn-secondary');
                    el.classList.add('btn-primary');
                } else {
                    el.classList.remove('btn-primary');
                    el.classList.add('btn-secondary');
                }
            });

            // Update Step Labels
            document.querySelectorAll('.step-label').forEach((el, index) => {
                const stepNum = index + 2;
                if (stepNum <= currentStep) {
                    el.classList.remove('text-muted');
                    el.classList.add('text-primary');
                } else {
                    el.classList.remove('text-primary');
                    el.classList.add('text-muted');
                }
            });


            // Show/Hide Steps
            document.querySelectorAll('.step-content').forEach((el, index) => {
                if (index + 1 === currentStep) {
                    el.classList.remove('d-none');
                } else {
                    el.classList.add('d-none');
                }
            });

            // Update Buttons
            // Back button visibility
            if (currentStep === 1) {
                prevBtn.classList.add('text-muted');
                prevBtn.setAttribute('disabled', 'true');
            } else {
                prevBtn.classList.remove('text-muted');
                prevBtn.removeAttribute('disabled');
            }

            if (currentStep === steps) {
                nextBtn.classList.add('d-none');
                saveDraftBtn.classList.add('d-none');
                submitBtn.classList.remove('d-none');

                // Hide main title/desc on step 4 as it has its own
                document.getElementById('stepTitle').classList.add('d-none');
                document.getElementById('stepDescription').classList.add('d-none');

                populateReview();
            } else {
                nextBtn.classList.remove('d-none');
                saveDraftBtn.classList.remove('d-none');
                submitBtn.classList.add('d-none');

                // Show main title/desc on other steps
                document.getElementById('stepTitle').classList.remove('d-none');
                document.getElementById('stepDescription').classList.remove('d-none');
            }

            // Update Header Text
            const titles = [
                "Rider Details", "Driver's License", "Ejari & Contracts", "Review"
            ];
            const descriptions = [
                "Please provide your personal information to get started.",
                "Please provide your driving license details and upload a clear image of the document.",
                "Upload necessary housing/contract documents.",
                "Review all information before final submission."
            ];

            if (currentStep < 4) {
                document.getElementById('stepTitle').textContent = titles[currentStep - 1];
                document.getElementById('stepDescription').textContent = descriptions[currentStep - 1];
            }
        }

        function validateStep() {
            const currentStepEl = document.getElementById(`step${currentStep}`);
            const inputs = currentStepEl.querySelectorAll('input[required]');
            let isValid = true;

            inputs.forEach(input => {
                // If checkbox, check checked state
                if (input.type === 'checkbox') {
                    if (!input.checked) {
                        isValid = false;
                        input.classList.add('is-invalid');
                    } else {
                        input.classList.remove('is-invalid');
                    }
                } else {
                    if (!input.value.trim()) {
                        isValid = false;
                        input.classList.add('is-invalid');
                    } else {
                        input.classList.remove('is-invalid');
                    }
                }
            });

            return isValid;
        }

        function populateReview() {
            // Helper to get value safely
            const val = (name) => {
                const el = document.querySelector(`[name="${name}"]`);
                return el && el.value ? el.value : '-';
            };
            const fileVal = (name) => {
                const input = document.querySelector(`[name="${name}"]`);
                if (input && input.files && input.files[0]) {
                    return input.files[0].name;
                }
                return 'No file uploaded';
            };

            document.getElementById('reviewName').textContent = `${val('first_name')} ${val('last_name')}`;
            document.getElementById('reviewEmail').textContent = val('email');
            document.getElementById('reviewPhone').textContent = val('phone');
            document.getElementById('reviewAddress').textContent = val('address'); // Removed city as it doesn't exist
            document.getElementById('reviewPictureFile').textContent = fileVal('picture');

            document.getElementById('reviewLicense').textContent = val('license_number');
            document.getElementById('reviewLicenseExp').textContent = val('license_expiry_date');
            document.getElementById('reviewLicenseFile').textContent = fileVal('license_image');

            document.getElementById('reviewEjari').textContent = val('ejari_number');
            document.getElementById('reviewEjariExp').textContent = val('ejari_expiry_date');
            document.getElementById('reviewEjariFile').textContent = fileVal('ejari_image');
        }

        nextBtn.addEventListener('click', () => {
            if (validateStep()) {
                if (currentStep < steps) {
                    currentStep++;
                    updateUI();
                }
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 1) {
                currentStep--;
                updateUI();
            }
        });

        // File Upload Interaction (Visual feedback)
        const fileInputs = document.querySelectorAll('input[type="file"]');
        fileInputs.forEach(input => {
            input.addEventListener('change', function () {
                const parent = this.closest('.upload-area');
                if (parent && this.files && this.files[0]) {
                    const fileNameFn = parent.querySelector('h6');
                    if (fileNameFn) fileNameFn.textContent = this.files[0].name;
                    parent.classList.add('border-success');
                    parent.classList.remove('border-primary');
                }
            });
        });

        // Initialize
        updateUI();
    });
</script>
{% endblock %}